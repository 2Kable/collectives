
{% extends 'base.html' %}

{% block additionalhead %}
  <script src="{{ url_for('static', filename='js/payment/edit_prices.js') }}"></script>
  <script> window.onload = updateNewItemTitleVisibility(); </script>
{% endblock %}

{% block header %}
  <h1>{% block title %}{{event.title}}{% endblock %}</h1>
{% endblock %}

{% block content %}
<div class="panel" id="administration">
  <h3>{{event.title}}</h3>
  <p><a class="button button-secondary" href="{{url_for('event.view_event', event_id=event.id)}}">Retour à la collective</a></p>

  <h4>Édition des tarifs</h4>
  Pour rendre la collective payante, définissez un ou plusieurs tarifs.

  <h5> Tarifs existants </h5>
  {% if form.items %}

    <form method="POST">
    <table id="existing_prices">
    <thead>
      <th> Objet du paiement </th>
      <th> Intitulé du tarif </th>
      <th> Prix en euros </th>
      <th> Actif </th>
    </thead>
    {% for item_form in form.items %}
      {{item_form.item_id}}
    
      {% for field in item_form.item_prices %}
        <tr>
          <td> {% if loop.first %} {{item_form.title}} {% endif %}</td>
          <td> {{ field.title() }} </td>
          <td>
          {{ field.amount(type="number", min="0.00", max=config['PAYMENTS_MAX_PRICE'], step="0.01", lang="fr-FR")}}
          </td>
          <td> {{ field.enabled() }} </td>
          <td> {{field.price_id}} 
          {% if field.use_count %}
            Utilisé {{field.use_count}} fois.
          {% else %}
            {{field.delete}} {{field.delete.label}}
          {% endif %}
          </td>
        </tr>
        {% if field.errors %}
        <tr> <td colspan="4" class="error-cell">
          <div class="form-errors">
              {% for field_name, errors in field.errors.items() %}
              {% for error in errors %}
              <div class="flash flash-error">
                  <strong>Erreur: {{field[field_name].label}}:</strong> {{error}}
              </div>
              {% endfor %}
              {% endfor %}
          </div>
        </td> </tr>
        {%endif%}
      {% endfor %}
    {% endfor %}
    </table>

    {{ form.hidden_tag() }}
    <br />{{ form.update(class="button button-primary") }}
    </form>
    {%else%}
      Aucun tarif n'a été défini pour le moment.
    {%endif%}

    <h5> Nouveau tarif </h5>
    <form method="POST">

    <div class="form-errors">
        {% for field_name, errors in new_price_form.errors.items() %}
        {% for error in errors %}
        <div class="flash flash-error">
            <strong>Erreur: {{new_price_form[field_name].label}}:</strong> {{error}}
        </div>
        {% endfor %}
        {% endfor %}
    </div>

    <div class="field">{{ new_price_form.existing_item.label }}<span class="help">Ajouter le tarif à un objet existant ou créer un nouvel objet</span></div>
    {{ new_price_form.existing_item(onchange="updateNewItemTitleVisibility();")}}
    <div id = "new-item-title">
      <div class="field">{{ new_price_form.item_title.label }}<span class="help">Par exemple «Nuitée en refuge»</span></div>
      {{ new_price_form.item_title}}
    </div>
    <div class="field">{{ new_price_form.title.label }}<span class="help">Par exemple «Adultes»</span></div>
    {{ new_price_form.title}}

    <div class="field">{{ new_price_form.amount.label }}<span class="help">{{ new_price_form.amount.description }}</span></div>
    {{ new_price_form.amount(type="number", min="0.00", max=config['PAYMENTS_MAX_PRICE'], step="0.01", lang="fr-FR")}}
    {#{ new_price_form.amount()}#}

    {{ new_price_form.enabled }} {{new_price_form.enabled.label}}
    
    {{ new_price_form.hidden_tag() }}
    <br />{{ new_price_form.add(class="button button-primary") }}
    </form>

</div>
{% endblock %}

